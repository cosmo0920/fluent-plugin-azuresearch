<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>fluent-plugin-azuresearch by yokawasa</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>fluent-plugin-azuresearch</h1>
          <h2>Azure Search Output Plugin for Fluentd</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/yokawasa/fluent-plugin-azuresearch/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/yokawasa/fluent-plugin-azuresearch/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/yokawasa/fluent-plugin-azuresearch" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>
<a id="azure-search-output-plugin-for-fluentd" class="anchor" href="#azure-search-output-plugin-for-fluentd" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Azure Search output plugin for Fluentd</h1>

<p>fluent-plugin-azuresearch is a fluent plugin to output to Azure Search</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>$ gem install fluent-plugin-azuresearch
</code></pre>

<h2>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h2>

<h3>
<a id="azure-search" class="anchor" href="#azure-search" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Azure Search</h3>

<p>To use Microsoft Azure Search, you must create an Azure Search service in the Azure Portal. Also you must have an index, persisted storage of documents to which fluent-plugin-azuresearch writes event stream out. Here are instructions:</p>

<ul>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/search-create-service-portal/">Create a service</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/search-what-is-an-index/">Create an index</a></li>
</ul>

<h3>
<a id="fluentd---fluentconf" class="anchor" href="#fluentd---fluentconf" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Fluentd - fluent.conf</h3>

<pre><code>&lt;match azuresearch.*&gt;
    @type azuresearch
    endpoint   https://AZURE_SEARCH_ACCOUNT.search.windows.net
    api_key    AZURE_SEARCH_API_KEY
    search_index  messages
    column_names id,user_name,message,tag,created_at
    key_names postid,user,content,tag,posttime
&lt;/match&gt;
</code></pre>

<ul>
<li>
<strong>endpoint (required)</strong> - Azure Search service endpoint URI</li>
<li>
<strong>api_key (required)</strong> - Azure Search API key</li>
<li>
<strong>search_index (required)</strong> - Azure Search Index name to insert records</li>
<li>
<strong>column_names (required)</strong> - Column names in a target Azure search index. Each column needs to be separated by a comma.</li>
<li>
<strong>key_names (optional)</strong> - Default:nil. Key names in incomming record to insert. Each key needs to be separated by a comma. ${time} is placeholder for Time.at(time).strftime("%Y-%m-%dT%H:%M:%SZ"), and ${tag} is placeholder for tag. By default, <strong>key_names</strong> is as same as <strong>column_names</strong>
</li>
</ul>

<h2>
<a id="sample-configurations" class="anchor" href="#sample-configurations" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Sample Configurations</h2>

<h3>
<a id="case1---column_names-is-as-same-as-key_names" class="anchor" href="#case1---column_names-is-as-same-as-key_names" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Case1 - column_names is as same as key_names</h3>

<p>Suppose you have the following fluent.conf and azure search index schema:</p>

<p>fluent.conf</p>

<pre><code>&lt;match azuresearch.*&gt;
    @type azuresearch
    endpoint   https://yoichidemo.search.windows.net
    api_key    2XX3D2456052A9AD21E54CB03C3ABF6A(dummy)
    search_index  messages
    column_names id,user_name,message,created_at
&lt;/match&gt;
</code></pre>

<p>Azure Search Schema: messages</p>

<pre><code>{
    "name": "messages",
    "fields": [
        { "name":"id", "type":"Edm.String", "key": true, "searchable": false },
        { "name":"user_name", "type":"Edm.String" },
        { "name":"message", "type":"Edm.String", "filterable":false, "sortable":false, "facetable":false, "analyzer":"en.lucene" },
        { "name":"created_at", "type":"Edm.DateTimeOffset", "facetable":false}
    ]
}
</code></pre>

<p>The plugin will write event stream out to Azure Ssearch like this:</p>

<p>Input event stream</p>

<pre><code>{ "id": "1", "user_name": "taylorswift13", "message":"post by taylorswift13", "created_at":"2016-01-29T00:00:00Z" },
{ "id": "2", "user_name": "katyperry", "message":"post by katyperry", "created_at":"2016-01-30T00:00:00Z" },
{ "id": "3", "user_name": "ladygaga", "message":"post by ladygaga", "created_at":"2016-01-31T00:00:00Z" }
</code></pre>

<p>Search results</p>

<pre><code>"value": [
    { "@search.score": 1, "id": "1", "user_name": "taylorswift13", "message": "post by taylorswift13", "created_at": "2016-01-29T00:00:00Z" },
    { "@search.score": 1, "id": "2", "user_name": "katyperry", "message": "post by katyperry", "created_at": "2016-01-30T00:00:00Z" },
    { "@search.score": 1, "id": "3", "user_name": "ladygaga", "message": "post by ladygaga", "created_at": "2016-01-31T00:00:00Z" }
]
</code></pre>

<h3>
<a id="case2---column_names-is-not-as-same-as-key_names" class="anchor" href="#case2---column_names-is-not-as-same-as-key_names" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Case2 - column_names is NOT as same as key_names</h3>

<p>Suppose you have the following fluent.conf and azure search index schema:</p>

<p>fluent.conf</p>

<pre><code>&lt;match azuresearch.*&gt;
    @type azuresearch
    endpoint   https://yoichidemo.search.windows.net
    api_key    2XX3D2456052A9AD21E54CB03C3ABF6A(dummy)
    search_index  messages
    column_names id,user_name,message,created_at
    key_names postid,user,content,posttime
&lt;/match&gt;
</code></pre>

<p>Azure Search Schema: messages</p>

<pre><code>{
    "name": "messages",
    "fields": [
        { "name":"id", "type":"Edm.String", "key": true, "searchable": false },
        { "name":"user_name", "type":"Edm.String" },
        { "name":"message", "type":"Edm.String", "filterable":false, "sortable":false, "facetable":false, "analyzer":"en.lucene" },
        { "name":"created_at", "type":"Edm.DateTimeOffset", "facetable":false}
    ]
}
</code></pre>

<p>The plugin will write event stream out to Azure Ssearch like this:</p>

<p>Input event stream</p>

<pre><code>{ "postid": "1", "user": "taylorswift13", "content":"post by taylorswift13", "posttime":"2016-01-29T00:00:00Z" },
{ "postid": "2", "user": "katyperry", "content":"post by katyperry", "posttime":"2016-01-30T00:00:00Z" },
{ "postid": "3", "user": "ladygaga", "content":"post by ladygaga", "posttime":"2016-01-31T00:00:00Z" }
</code></pre>

<p>Search results</p>

<pre><code>"value": [
    { "@search.score": 1, "id": "1", "user_name": "taylorswift13", "message": "post by taylorswift13", "created_at": "2016-01-29T00:00:00Z" },
    { "@search.score": 1, "id": "2", "user_name": "katyperry", "message": "post by katyperry", "created_at": "2016-01-30T00:00:00Z" },
    { "@search.score": 1, "id": "3", "user_name": "ladygaga", "message": "post by ladygaga", "created_at": "2016-01-31T00:00:00Z" }
]
</code></pre>

<h3>
<a id="case3---column_names-is-not-as-same-as-key_names-plus-key_names-includes-time-and-tag" class="anchor" href="#case3---column_names-is-not-as-same-as-key_names-plus-key_names-includes-time-and-tag" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Case3 - column_names is NOT as same as key_names, Plus, key_names includes ${time} and ${tag}</h3>

<p>fluent.conf</p>

<pre><code>&lt;match azuresearch.*&gt;
    @type azuresearch
    endpoint   https://yoichidemo.search.windows.net
    api_key    2XX3D2456052A9AD21E54CB03C3ABF6A(dummy)
    search_index  messages
    column_names id,user_name,message,tag,created_at
    key_names postid,user,content,${tag},${time}
&lt;/match&gt;
</code></pre>

<p>Azure Search Schema: messages</p>

<pre><code>{
    "name": "messages",
    "fields": [
        { "name":"id", "type":"Edm.String", "key": true, "searchable": false },
        { "name":"user_name", "type":"Edm.String" },
        { "name":"message", "type":"Edm.String", "filterable":false, "sortable":false, "facetable":false, "analyzer":"en.lucene" },
        { "name":"created_at", "type":"Edm.DateTimeOffset", "facetable":false}
    ]
}
</code></pre>

<p>The plugin will write event stream out to Azure Ssearch like this:</p>

<p>Input event stream</p>

<pre><code>{ "id": "1", "user_name": "taylorswift13", "message":"post by taylorswift13" },
{ "id": "2", "user_name": "katyperry", "message":"post by katyperry" },
{ "id": "3", "user_name": "ladygaga", "message":"post by ladygaga" }
</code></pre>

<p>Search results</p>

<pre><code>"value": [
    { "@search.score": 1, "id": "1", "user_name": "taylorswift13", "message": "post by taylorswift13", "tag": "azuresearch.msg", "created_at": "2016-01-31T21:03:41Z" },
    { "@search.score": 1, "id": "2", "user_name": "katyperry", "message": "post by katyperry", "tag": "azuresearch.msg", "created_at": "2016-01-31T21:03:41Z" },
    { "@search.score": 1, "id": "3", "user_name": "ladygaga", "message": "post by ladygaga", "tag": "azuresearch.msg", "created_at": "2016-01-31T21:03:41Z" }
]
</code></pre>

<p>[note] the value of created_at above is the time when fluentd actually recieves its corresponding input event.</p>

<h2>
<a id="tests" class="anchor" href="#tests" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tests</h2>

<h3>
<a id="running-test-code" class="anchor" href="#running-test-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Running test code</h3>

<pre><code>$ git clone https://github.com/yokawasa/fluent-plugin-azuresearch.git
$ cd fluent-plugin-azuresearch

# edit CONFIG params of test/plugin/test_azuresearch.rb 
$ vi test/plugin/test_azuresearch.rb

# run test 
$ rake test
</code></pre>

<h3>
<a id="creating-package-running-and-testing-locally" class="anchor" href="#creating-package-running-and-testing-locally" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Creating package, running and testing locally</h3>

<pre><code>$ rake build
$ rake install:local

# running fluentd with your fluent.conf
$ fluentd -c fluent.conf -vv &amp;

# send test input event to test plugin using fluent-cat
$ echo ' { "postid": "100", "user": "ladygaga", "content":"post by ladygaga"}' | fluent-cat azuresearch.msg
</code></pre>

<p>Please don't forget that you need forward input configuration to receive the message from fluent-cat</p>

<pre><code>&lt;source&gt;
    @type forward
&lt;/source&gt;
</code></pre>

<h2>
<a id="todos" class="anchor" href="#todos" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>TODOs</h2>

<ul>
<li>Input validation for Azure Search - check total size of columns to add </li>
</ul>

<h2>
<a id="change-log" class="anchor" href="#change-log" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Change log</h2>

<ul>
<li><a href="ChangeLog.md">Changelog</a></li>
</ul>

<h2>
<a id="links" class="anchor" href="#links" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Links</h2>

<ul>
<li><a href="http://yokawasa.github.io/fluent-plugin-azuresearch">http://yokawasa.github.io/fluent-plugin-azuresearch</a></li>
<li><a href="https://rubygems.org/gems/fluent-plugin-azuresearch">https://rubygems.org/gems/fluent-plugin-azuresearch</a></li>
</ul>

<h2>
<a id="contributing" class="anchor" href="#contributing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Contributing</h2>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/yokawasa/fluent-plugin-azuresearch">https://github.com/yokawasa/fluent-plugin-azuresearch</a>.</p>

<h2>
<a id="copyright" class="anchor" href="#copyright" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Copyright</h2>

<table>
  <tr>
    <td>Copyright</td>
<td>Copyright (c) 2016- Yoichi Kawasaki</td>
  </tr>
  <tr>
    <td>License</td>
<td>Apache License, Version 2.0</td>
  </tr>
</table>
        </section>

        <footer>
          fluent-plugin-azuresearch is maintained by <a href="https://github.com/yokawasa">yokawasa</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>
